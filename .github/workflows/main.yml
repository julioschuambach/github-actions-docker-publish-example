name: Build and Publish to Dockerhub

on:
  push:
    branches:
      - main
      - development

jobs:
  runs-on: windows-latest
  dotnet_build:

    steps:
    - name: checkout
      uses: actions/checkout@main

    - name: Setup dotnet
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '8.0.x'

    - name: Clean solution
      run: dotnet clean "./HelloWorld"

    - name: Restore solution
      run: dotnet restore "./HelloWorld"

    - name: Build project
      run: dotnet build "./HelloWorld" --configuration Release

    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v3.1.0
      with:
        name: hello-world-api-artifact
        path: .

  docker_build_and_publish:
    needs: dotnet_build

    steps:
    - name: checkout
      uses: actions/checkout@main

    - name: Download a Build Artifact
      uses: actions/download-artifact@v3.0.0
      with:
        name: hello-world-api-artifact

    - name: Build image
      run: docker build . -t julioschuambach/hello-world-api:latest

    - name: Publish image
      run: docker login -u julioschuambach -p ${{ secrets.DOCKER_TOKEN }}
           docker push julioschuambach/hello-world-api:latest